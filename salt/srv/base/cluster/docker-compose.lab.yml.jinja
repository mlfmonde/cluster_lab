version: '3.0'
services:

  consul:
    command: ["agent", "-server", {% for server, addrs in salt['mine.get']('*', 'network.ip_addrs') | dictsort() %}"-retry-join={{ addrs[0] }}", {% endfor %}"-ui", "-bootstrap-expect=4"]
    environment:
        CONSUL_LOCAL_CONFIG: '{
            "enable_script_checks": true,
            "watches": [{
                "type": "event",
                "handler_type": "script",
                "args": ["/handler.py"]}]
            }'
        CONSUL_BIND_INTERFACE: eth1
    extra_hosts:
      # to make consul checks happy, force using local haproxy as we
      # have no dns resolution at the moment
      - "service.cluster.lab:127.0.0.1"
